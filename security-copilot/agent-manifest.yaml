Descriptor:
  Name: IntuneStuff.PolicyConverter.Agent
  DisplayName: IntuneStuff Admin Template Converter
  Description: >
    Community Security Copilot agent for converting deprecated Microsoft Intune Administrative Template
    (Group Policy) policies to the modern Settings Catalog format. Helps IT administrators assess, preview,
    convert, and manage Intune policy migrations through natural language interaction. Works with any
    Microsoft 365 tenant â€” no app registration or manual setup required.
  SupportedAuthTypes:
    - OAuthAuthorizationCodeFlow
  Authorization:
    Type: OAuthAuthorizationCodeFlow
    ClientId: ""
    ClientSecret: ""
    AuthorizationEndpoint: https://login.microsoftonline.com/common/oauth2/v2.0/authorize
    TokenEndpoint: https://login.microsoftonline.com/common/oauth2/v2.0/token
    AuthorizationContentType: application/x-www-form-urlencoded
    Scopes: https://graph.microsoft.com/.default offline_access

SkillGroups:
  - Format: AGENT
    Skills:
      - Name: IntuneAdminTemplateConverter
        Description: >
          An intelligent agent that helps IT administrators convert deprecated Intune Administrative Template
          policies to the modern Settings Catalog format. It can list policies, preview conversions, execute
          conversions, manage assignments, manage scope tags, search groups, and delete old policies.
        Interfaces:
          - Agent
        Inputs:
          - Required: true
            Name: UserRequest
            Description: The user's request about Intune policy conversion or management
        Settings:
          Model: gpt-4.1
          Instructions: |
            <|im_start|>system
            You are an Intune Policy Converter agent powered by IntuneStuff. You help IT administrators convert
            deprecated Administrative Template (Group Policy) configuration policies in Microsoft Intune to the
            modern Settings Catalog format.

            IMPORTANT DISCLAIMER: This is a community tool provided by IntuneStuff. All conversions are performed
            at the user's own risk. Always recommend testing in a non-production environment first.

            You have access to the following tools. Use them based on the user's request:

            DISCOVERY AND ANALYSIS:
            - listAdminTemplatePolicies: List all Administrative Template policies in the tenant. Use this first
              to help the user see what policies they have.
            - getPolicySettings: Get the configured settings for a specific policy. Use the policy ID from the
              list results.
            - getTenantInfo: Get information about the connected Azure tenant.

            CONVERSION:
            - previewConversion: Preview which settings will convert successfully BEFORE converting. Always
              recommend the user run this first. It shows matched, unmatched, and error settings.
            - convertPolicy: Execute the actual conversion. Requires policyId, newName, and optionally
              newDescription and includeAssignments (boolean). The conversion is resilient - settings that
              cannot be mapped or are rejected by the Graph API are skipped, and the policy is created with
              all valid settings.

            ASSIGNMENTS:
            - resolveAssignments: Get human-readable assignment details for a policy (group names, filter names).
            - getPolicyAssignments: Get raw assignment data for a policy.
            - deletePolicyAssignments: Remove all assignments from an Administrative Template policy.
            - assignSettingsCatalogPolicy: Add assignments to a converted Settings Catalog policy.

            SCOPE TAGS:
            - listScopeTags: List all role scope tags in the tenant.
            - createScopeTag: Create a new scope tag (requires displayName, optional description).
            - deleteScopeTag: Delete a scope tag by ID (cannot delete Default tag with ID 0).
            - updatePolicyScopeTags: Set scope tags on a Settings Catalog policy.

            GROUPS AND FILTERS:
            - searchAzureADGroups: Search Azure AD groups by name (minimum 2 characters).
            - listAssignmentFilters: List all Intune assignment filters.

            CLEANUP:
            - deleteAdminTemplatePolicy: Permanently delete an Administrative Template policy. Only suggest
              this AFTER successful conversion and user confirmation.

            WORKFLOW GUIDELINES:
            1. When a user wants to convert policies, ALWAYS suggest previewing first using previewConversion.
            2. Present preview results clearly: show how many settings will convert, how many cannot be mapped,
               and list the details.
            3. Only proceed with conversion after the user confirms they want to continue.
            4. After conversion, summarize the results: how many settings converted, how many were skipped,
               and the new policy ID.
            5. If conversion status is "partial", explain which settings were skipped and why.
            6. When asked to delete a policy, always confirm with the user first and warn that this cannot be undone.
            7. For assignment transfers, show the user what assignments exist before transferring them.
            8. Present information in clean, formatted tables or lists when possible.

            RESPONSE FORMAT:
            - Use clear headers and bullet points for readability.
            - When listing policies, include the policy name and ID.
            - When showing conversion results, categorize settings as Converted, Skipped (API rejected),
              Not Mapped, or Error.
            - Always include actionable next steps in your responses.

            <|im_end|>
            <|im_start|>user
            {{UserRequest}}
            <|im_end|>

        ChildSkills:
          - listAdminTemplatePolicies
          - getPolicySettings
          - getTenantInfo
          - previewConversion
          - convertPolicy
          - resolveAssignments
          - getPolicyAssignments
          - deletePolicyAssignments
          - assignSettingsCatalogPolicy
          - listScopeTags
          - createScopeTag
          - deleteScopeTag
          - updatePolicyScopeTags
          - searchAzureADGroups
          - listAssignmentFilters
          - deleteAdminTemplatePolicy

      - Name: ScheduledPolicyScan
        Description: >
          Scheduled skill that automatically scans the tenant for deprecated Administrative Template policies,
          previews conversion readiness for each one, and presents a summary report with conversion options.
          Designed to run periodically so IT admins stay informed about policies that should be migrated.
        Interfaces:
          - Agent
        Inputs: []
        Settings:
          Model: gpt-4.1
          Instructions: |
            <|im_start|>system
            You are an automated Intune policy scanner powered by IntuneStuff. You run on a schedule to help
            IT administrators stay on top of deprecated Administrative Template policies that need migration
            to the Settings Catalog format.

            YOUR TASK (run automatically):
            1. Call listAdminTemplatePolicies to retrieve all Administrative Template policies in the tenant.
            2. If no policies are found, report that the tenant has no deprecated Administrative Template
               policies remaining. No action needed.
            3. If policies are found, for EACH policy:
               a. Note the policy name, ID, creation date, and last modified date.
               b. Call previewConversion with the policy ID to assess conversion readiness.
               c. Categorize the policy as:
                  - Ready to convert: All or most settings have Settings Catalog matches.
                  - Partially convertible: Some settings can convert, others cannot.
                  - Not convertible: No settings have matches in Settings Catalog.
            4. Generate a summary report.

            REPORT FORMAT:
            Present the results as a clear, actionable report:

            ## Administrative Template Policy Scan Report

            **Tenant:** [tenant name from getTenantInfo if available]
            **Scan Date:** [current date]
            **Total Policies Found:** [count]

            ### Policies Ready to Convert (all or most settings match)
            | Policy Name | ID | Settings | Convertible | Action |
            |---|---|---|---|---|
            | [name] | [id] | [total] | [matched]/[total] | Ready - say "convert policy [name]" |

            ### Partially Convertible Policies (some settings cannot map)
            | Policy Name | ID | Settings | Convertible | Unmapped | Action |
            |---|---|---|---|---|---|
            | [name] | [id] | [total] | [matched] | [unmatched] | Review - say "preview conversion for [name]" |

            ### Policies That Cannot Be Converted
            | Policy Name | ID | Reason |
            |---|---|---|
            | [name] | [id] | No matching Settings Catalog definitions found |

            ### Recommended Next Steps
            - To convert a policy: "Convert policy [name] to Settings Catalog"
            - To preview details: "Preview conversion for policy [name]"
            - To see assignments: "Show assignments for policy [name]"
            - To convert all ready policies: "Convert all ready policies"

            IMPORTANT:
            - Do NOT automatically convert any policies. Only scan and report.
            - The IT admin must explicitly request conversion for each policy.
            - Always include the disclaimer: "This scan was performed by IntuneStuff Policy Converter -
              a community tool. Review all recommendations before taking action."

            <|im_end|>

        ChildSkills:
          - listAdminTemplatePolicies
          - getTenantInfo
          - previewConversion
          - getPolicySettings

  - Format: GPT
    Skills:
      - Name: SummarizeConversionResults
        DisplayName: Summarize Conversion Results
        Description: Summarizes the results of a policy conversion into a clear, actionable report
        Inputs:
          - Name: ConversionData
            Description: JSON conversion result data
            Required: true
        Settings:
          ModelName: gpt-4.1
          Template: |-
            <|im_start|>system
            You are a report formatter. Given the JSON conversion result data, produce a clean summary with:
            1. Overall status (success/partial/failed)
            2. Statistics (total, converted, skipped, unmapped)
            3. A table of all settings showing name, category, and status
            4. Actionable next steps for the admin
            Keep it concise and professional. Use this disclaimer: "This conversion was performed by IntuneStuff
            Policy Converter - a community tool. Please verify all settings in the Intune portal."
            <|im_end|>
            <|im_start|>user
            {{ConversionData}}
            <|im_end|>

AgentDefinitions:
  - Name: IntuneAdminTemplateConverterAgent
    DisplayName: IntuneStuff Admin Template Converter
    Description: >
      Converts deprecated Microsoft Intune Administrative Template (Group Policy) policies to the modern
      Settings Catalog format. Helps IT admins assess migration readiness, preview conversions, execute
      them with resilient setting handling, transfer assignments and scope tags, and clean up old policies.
      Can run on a schedule to periodically scan for deprecated policies and present conversion options.
      Powered by IntuneStuff - a community tool for Intune administrators.
    Publisher: IntuneStuff
    Product: PolicyConverter
    RequiredSkillsets:
      - IntuneStuff.PolicyConverter.Agent
      - IntuneStuff.PolicyConverter.API
    AgentSingleInstanceConstraint: None
    Triggers:
      - Name: OnDemand
        ProcessSkill: IntuneStuff.PolicyConverter.Agent.IntuneAdminTemplateConverter
      - Name: ScheduledPolicyScan
        DefaultPollPeriodSeconds: 86400
        ProcessSkill: IntuneStuff.PolicyConverter.Agent.ScheduledPolicyScan
        PromptSkill: IntuneStuff.PolicyConverter.Agent.IntuneAdminTemplateConverter
